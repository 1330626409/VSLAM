# 直接稀疏法里程计

## 摘要  
DSO是一种新的基于直接法和稀疏法的视觉里程计，该方法将最小化光度误差模型和所有模型参数相结合。为了满足实时性，本文没有对图像进行光滑处理，而是对整个图像均匀采样。因为本文的方法不依赖于关键点检测和特征描述符，所以它可以在整个图像内采样具有强度梯度的像素点，包括白墙上的边缘和强度平滑变换的像素点，所提出的方法集成了完整的光度标定，考虑了完整的曝光时间，透镜晕影，非线性响应函数的影响。在三个不同的数据集进行了测试评估。实验表明，在跟踪精度和鲁棒性方面该方法明显优于其他的直接法和间接法。

## 介绍  

### 1. 直接法 VS 间接法  
直接法和间接法的本质都是一个概率模型，将含噪声的测量Y作为输入并且计算未知的模型参数的估计量。求解时通常采用最大似然方法，找到最大化实际测量概率的模型参数：  
$$X^*:=argmax_XP(Y|X)$$

间接法对测量数据进行预处理以产生中间层表示，之后将中间层的数据作为测量Y输入到概率模型中，以估计三维环境模型和相机运动。通常第一步是通过稀疏的特征点提取和匹配来实现的，然而也可以采用更加稠密的光流或者提取直线特征或曲线特征。  
而直接法直接跳过预处理步骤，直接使用像素值作为概率模型中的测量Y。  
对于摄像头而言，由于传感器提供光度测量，因此直接法优化的是光度误差，而间接法通过预处理，计算出地图点坐标或者光流向量，因此优化的是几何误差。  
### 2. 稀疏法 VS 稠密法  
稀疏法仅使用一小部分特殊像素点（比如边角），稠密法则使用图片中的所有像素，中间法（半稠密法）不重建完整的环境模型，但是仍然使用大部分具有良好连接和约束的像素点。  
在稀疏法中没有邻域的概念，并且几何参数（特征点位置）在给定相机位姿和内参的情况下是独立的。稠密法（半稠密法）利用所使用的图像区域的连通性来形成几何先验信息。如果仅使用被动视觉来重建稠密三维环境，几何先验是必须的。
>间接法+稀疏法  
这是应用最广泛的方法，通过匹配的特征点集，对环境模型和相机位姿进行估计。

>稠密法+间接法  
通过匹配的光流场，重建稠密的环境模型。  

>稠密法+直接法  
不仅使用几何先验信息，同时通过最小化光度误差来重建稠密的环境模型。相关工作有DTAM，LSD-SLAM  

>稀疏法+直接法  
该方法不考虑几何先验信息，直接优化光度误差。

### 3. 为什么采用  
本文采用直接法和稀疏法相结合的方法主要是基于以下考虑。  
(1)直接法  
基于特征点的直接法的主要优点是它对现有的摄像头拍摄的图像中存在的光度误差和几何失真具有高度鲁棒性。  
比如自动曝光变化，非线性响应函数（伽马矫正/白平衡），透镜衰减（渐晕），去耦合伪像和由卷帘快门引起的几何失真。  
但是，大多数应用于机器视觉相关的设备其配备的摄像头提供的图像数据是专门用于机器视觉算法的，而不仅仅用于人类娱乐消费。这些摄像头会提供完整的传感器模型，并且以最适合视觉算法处理的方式来提供数据，例如自动曝光和伽马矫正不是未知的噪声源，而是被并入到模型中，使得所获得的数据更准确，而且由于直接法利用整个图片中的像素强度信息，所以它将受益于更精确的传感器模型。  
直接法的优点之一是它不需要提取可重复识别的特征点，从而允许更细致的几何表示方法（逆深度值）。此外，直接法可从所有图像像素点中采样，生成更完整的环境模型，这提高了其在若纹理特征中使用的鲁棒性。  

(2)稀疏法  
稠密法的主要缺点是其利用的几何先验信息使得优化时需要考虑地图点之间的相关性，导致实时的联合优化估计变得不可行。  
因此现有的稠密法或半稠密法采用两种方法：  
>>a)忽略或者粗略近似几何参数（橙色）的相关性以及几何参数和相机位姿之间的相关性  
b)采用Primal-dual等方法对右下角子矩阵进行求解。

尽管稠密法使得重建的环境模型更加完整，细致，美观，但是几何先验信息会额外导入误差，当算法在大尺寸环境长时间运行时，反而会影响算法的精确，这个问题是通过提高几何先验信息的准确性和可靠性来解决。

![稀疏法VS稠密法](https://github.com/MRwangmaomao/VSLAM/blob/master/DSO/pic/sparse_vs_dense.png)  
左：稀疏法Hessian矩阵：由于右下角子矩阵是对角线矩阵，因此可通过舒尔补有效地提高计算效率。右：稠密法Hessian矩阵：几何先验信息会在右下角子矩阵中添加元素，通常是不规则的，不仅增大了计算量，还使得计算变得复杂，为了简单起见，上图并未包括相机内参。

### 4. 主要贡献
1. 提出了单目直接法和稀疏法结合的视觉里程计。目前是直接法中唯一优化所有模型的方法，包括相机位姿，相机内参和地图几何参数的（逆深度值）。
2. 采用滑动窗口优化算法，边缘化旧的图像帧和不在视角范围内的地图点。但是与现有方法相比，充分利用了相机光度标定（透镜衰减，伽马校正，已知的曝光时间）进一步提高了视觉里程计的精度和鲁棒性。
3. 可以在笔记本电脑上实时运行。在三个数据及上进行测试，实验表明在跟踪精度和鲁棒性方面该方法显著优于其他的直接法和间接法。当减少优化的关键帧和地图点数量时，计算速度可以提高5倍但是表现仍然超越最先进的间接法。

## 直接稀疏法模型  
DSO采用最小光度误差优化算法，并且考虑了光度标定模型，其优化范围不是所有帧，而是由最近帧及其前几帧形成的滑动窗口。与现有的直接法不同，DSO优化**所有参数模型**（包括相机内参，相机外参，逆深度值），但算法效率与间接法中常用的bundle adjustment算法相近。同时采用和其他直接法相同的地图点表示方法，即三维点被表示为相应坐标下的逆深度值，因此只有一个自由度。

